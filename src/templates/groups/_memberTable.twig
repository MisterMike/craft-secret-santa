{% import 'secret-santa/_macros/status.twig' as status %}

<table class="data fullwidth">
	<thead>
		<tr>
			<th>{{ 'Member'|t }}</th>
			<th>{{ 'Status'|t }}</th>
			<th>{{ 'Wishlist'|t }}</th>
			<th>{{ 'Invited'|t }}</th>
			<th>{{ 'Accepted'|t }}</th>
			<th class="thin"></th>
		</tr>
	</thead>

	<tbody>
    {% for member in members %}
		
		{% set user = craft.users.id(member.userId).one() %}

      <tr>
        <th scope="row">
          <a href="{{ cpUrl('secret-santa/group/' ~ group.id ~ '/member/' ~ member.id) }}">
            {{ user.fullName ?? user.username }}
          </a>
        </th>

    		<td>
    		  {% if member.dateAccepted %}
    		    {{ status.statusLabel('Accepted'|t('secret-santa'), 'green') }}
    		  {% elseif member.dateInvited %}
    		    {{ status.statusLabel('Invited'|t('secret-santa'), 'blue') }}
    		  {% else %}
    		    {{ status.statusLabel('New'|t('secret-santa'), 'gray') }}
    		  {% endif %}
    		</td>

        <td>
        <div class="chip small chromeless">
          <div class="chip-content">
            {% if member.wishlistRefused %}
            {{ status.statusBullet('Refused'|t, 'inactive') }}
          {% elseif member.wishlist %}
            {{ status.statusBullet('Refused'|t, 'active') }}
          {% else %}
            {{ status.statusBullet('Refused'|t, 'pending') }}
          {% endif %}
          </div>
        </div>
        </td>

        <td>
          {{ member.dateInvited ? member.dateInvited|date('short') : '—' }}
        </td>

        <td>
          {{ member.dateAccepted ? member.dateAccepted|date('short') : '—' }}
        </td>

        <td class="thin">
          <button
            type="button"
            class="btn small icon delete js-remove-member"
            data-user-id="{{ user.id }}"
            data-group-id="{{ group.id }}"
            title="{{ 'Remove'|t }}"
        ></button>

        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="6" class="light">
          {{ 'No members yet.'|t }} ok?
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% js %}
(() => {
    const buttons = document.querySelectorAll('.js-remove-member');

    buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const userId = btn.dataset.userId;
            const groupId = btn.dataset.groupId;

            if (!userId || !groupId) {
                return;
            }

            const confirmed = confirm(
                Craft.t('secret-santa', 'Remove this member from the group?')
            );

            if (!confirmed) {
                return;
            }

            try {
                const response = await Craft.postActionRequest(
                    'secret-santa/member/remove-member',
                    {
                        userId,
                        groupId,
                    }
                );

                if (response?.success) {
                    // Remove the table row
                    const row = btn.closest('tr');
                    row?.remove();

                    Craft.cp.displayNotice(
                        Craft.t('secret-santa', 'Member removed.')
                    );
                } else {
                    throw new Error('Request failed');
                }
            } catch (e) {
                Craft.cp.displayError(
                    Craft.t('secret-santa', 'Could not remove member.')
                );
            }
        });
    });
})();
{% endjs %}

